<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.336">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-05-07">

<title>Introduction to Keras - Lab</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Introduction_to_Keras-Lab_files/libs/clipboard/clipboard.min.js"></script>
<script src="Introduction_to_Keras-Lab_files/libs/quarto-html/quarto.js"></script>
<script src="Introduction_to_Keras-Lab_files/libs/quarto-html/popper.min.js"></script>
<script src="Introduction_to_Keras-Lab_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Introduction_to_Keras-Lab_files/libs/quarto-html/anchor.min.js"></script>
<link href="Introduction_to_Keras-Lab_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Introduction_to_Keras-Lab_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Introduction_to_Keras-Lab_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Introduction_to_Keras-Lab_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Introduction_to_Keras-Lab_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#package-requirements" id="toc-package-requirements" class="nav-link" data-scroll-target="#package-requirements">Package Requirements</a></li>
  <li><a href="#mnist" id="toc-mnist" class="nav-link" data-scroll-target="#mnist">MNIST</a></li>
  <li><a href="#prepare-data" id="toc-prepare-data" class="nav-link" data-scroll-target="#prepare-data">Prepare Data</a>
  <ul class="collapse">
  <li><a href="#shape-into-proper-tensor-form" id="toc-shape-into-proper-tensor-form" class="nav-link" data-scroll-target="#shape-into-proper-tensor-form">Shape into proper tensor form</a></li>
  <li><a href="#stabilize-learning-by-data-scaling" id="toc-stabilize-learning-by-data-scaling" class="nav-link" data-scroll-target="#stabilize-learning-by-data-scaling">Stabilize learning by data scaling</a></li>
  <li><a href="#randomize-data" id="toc-randomize-data" class="nav-link" data-scroll-target="#randomize-data">Randomize data</a></li>
  </ul></li>
  <li><a href="#balance-batch-size-default-learning-rate" id="toc-balance-batch-size-default-learning-rate" class="nav-link" data-scroll-target="#balance-batch-size-default-learning-rate">Balance Batch Size &amp; Default Learning Rate</a>
  <ul class="collapse">
  <li><a href="#your-turn-3min" id="toc-your-turn-3min" class="nav-link" data-scroll-target="#your-turn-3min">Your turn! (3min)</a></li>
  </ul></li>
  <li><a href="#pick-an-adaptive-learning-rate-optimizer" id="toc-pick-an-adaptive-learning-rate-optimizer" class="nav-link" data-scroll-target="#pick-an-adaptive-learning-rate-optimizer">Pick an Adaptive Learning Rate Optimizer</a>
  <ul class="collapse">
  <li><a href="#your-turn-5min" id="toc-your-turn-5min" class="nav-link" data-scroll-target="#your-turn-5min">Your turn! (5min)</a></li>
  </ul></li>
  <li><a href="#add-callbacks" id="toc-add-callbacks" class="nav-link" data-scroll-target="#add-callbacks">Add Callbacks</a>
  <ul class="collapse">
  <li><a href="#stop-training-at-the-right-time" id="toc-stop-training-at-the-right-time" class="nav-link" data-scroll-target="#stop-training-at-the-right-time">Stop training at the right time</a></li>
  <li><a href="#add-a-learning-rate-scheduler" id="toc-add-a-learning-rate-scheduler" class="nav-link" data-scroll-target="#add-a-learning-rate-scheduler">Add a learning rate scheduler</a></li>
  </ul></li>
  <li><a href="#explore-model-capacity" id="toc-explore-model-capacity" class="nav-link" data-scroll-target="#explore-model-capacity">Explore Model Capacity</a>
  <ul class="collapse">
  <li><a href="#your-turn-5min-1" id="toc-your-turn-5min-1" class="nav-link" data-scroll-target="#your-turn-5min-1">Your turn! (5min)</a></li>
  <li><a href="#smart-experimenting" id="toc-smart-experimenting" class="nav-link" data-scroll-target="#smart-experimenting">Smart experimenting</a></li>
  <li><a href="#your-turn-3-min" id="toc-your-turn-3-min" class="nav-link" data-scroll-target="#your-turn-3-min">Your turn! (3 min)</a></li>
  </ul></li>
  <li><a href="#regularize-overfitting" id="toc-regularize-overfitting" class="nav-link" data-scroll-target="#regularize-overfitting">Regularize Overfitting</a>
  <ul class="collapse">
  <li><a href="#weight-decay" id="toc-weight-decay" class="nav-link" data-scroll-target="#weight-decay">Weight decay</a></li>
  <li><a href="#dropout" id="toc-dropout" class="nav-link" data-scroll-target="#dropout">Dropout</a></li>
  </ul></li>
  <li><a href="#repeat" id="toc-repeat" class="nav-link" data-scroll-target="#repeat">Repeat</a></li>
  <li><a href="#evaluate-results" id="toc-evaluate-results" class="nav-link" data-scroll-target="#evaluate-results">Evaluate results</a>
  <ul class="collapse">
  <li><a href="#confusion-matrix" id="toc-confusion-matrix" class="nav-link" data-scroll-target="#confusion-matrix">Confusion matrix</a></li>
  <li><a href="#visualize-missed-predictions" id="toc-visualize-missed-predictions" class="nav-link" data-scroll-target="#visualize-missed-predictions">Visualize missed predictions</a></li>
  </ul></li>
  <li><a href="#visualize-missed-predictions-1" id="toc-visualize-missed-predictions-1" class="nav-link" data-scroll-target="#visualize-missed-predictions-1">Visualize missed predictions</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key takeaways</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a>
  <ul class="collapse">
  <li><a href="#workshops" id="toc-workshops" class="nav-link" data-scroll-target="#workshops">Workshops</a></li>
  <li><a href="#books" id="toc-books" class="nav-link" data-scroll-target="#books">Books</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Introduction_to_Keras-Lab.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Introduction to Keras - Lab</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 7, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This lab has been adapted from the first lab in the <a href="https://github.com/rstudio-conf-2020/dl-keras-tf">Workshop on Deep learning with keras and Tensorflow in R (Rstudio conf. 2020)</a>, and has been downladed and re-created to ensure its usability.</p>
<p>The lab is oriented to provide a first contact with Keras in R and presents the main steps required for building training and using a deepl learning model using Keras and R as summarized in the Keras Cheatshhet:</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-1_dd884d6068e0be3768b6aa4a88436b2b">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"images/kerasPipeline.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="images/kerasPipeline.png" class="img-fluid" width="410"></p>
</div>
</div>
<p>The following steps provide a good mental model for tuning a model.</p>
<p>It is important to recall that though they don’t guarantee you’ll find the optimal model; however, it should give you a higher probability of finding a near optimal one.</p>
<ol type="1">
<li>Prepare data</li>
<li>Balance batch size with a default learning rate</li>
<li>Tune the adaptive learning rate optimizer</li>
<li>Add callbacks to control training</li>
<li>Explore model capacity</li>
<li>Regularize overfitting</li>
<li>Repeat steps 1-6</li>
<li>Evaluate final model results</li>
</ol>
<p>We’ll demonstrate with one of the most famous benchmark data sets, MNIST. We’ll work with a multi-layer perceptron (MLP), but realize that <em>these steps also translate to other DL models (i.e.&nbsp;CNNs, RNNs, LSTMs)</em>.</p>
</section>
<section id="package-requirements" class="level1">
<h1>Package Requirements</h1>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-2_20ae1244dbf2121854c02e968bd1f2ee">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)       <span class="co"># for modeling</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)   <span class="co"># for wrangling &amp; visualization</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)        <span class="co"># for string literals</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)  <span class="co"># Interface to 'Python'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mnist" class="level1">
<h1>MNIST</h1>
<p><code>keras</code> has many built in data sets (or functions to automatically install data sets). Check out the available datasets with <code>dataset_</code> + tab.</p>
<p>We’re going to use the <strong>MNIST</strong> data set which is the “hello world” for learning deep learning! <a href="http://yann.lecun.com/exdb/mnist/">ℹ️</a></p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/data_822579afabf376347254b1e8fc1ea8e9">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>mnist <span class="ot">&lt;-</span> <span class="fu">dataset_mnist</span>()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(mnist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ train:List of 2
  ..$ x: int [1:60000, 1:28, 1:28] 0 0 0 0 0 0 0 0 0 0 ...
  ..$ y: int [1:60000(1d)] 5 0 4 1 9 2 1 3 1 4 ...
 $ test :List of 2
  ..$ x: int [1:10000, 1:28, 1:28] 0 0 0 0 0 0 0 0 0 0 ...
  ..$ y: int [1:10000(1d)] 7 2 1 0 4 1 4 9 5 9 ...</code></pre>
</div>
</div>
<p>Our training images (aka <em>features</em>) are stored as 3D arrays:</p>
<ul>
<li>60,000 images consisting of a…</li>
<li>28x28 matrix with…</li>
<li>values ranging from 0-255 representing gray scale pixel values.</li>
</ul>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/features_fdb29c3291c17c69bea35d4897e46e1c">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 60K images of 28x28 pixels</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(mnist<span class="sc">$</span>train<span class="sc">$</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 60000    28    28</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pixel values are gray scale ranging from 0-255</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(mnist<span class="sc">$</span>train<span class="sc">$</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   0 255</code></pre>
</div>
</div>
<p>Notice, however, that the labels, which indicate the “true” number associated with the image are stored as a vector, because per each image (a 2-D array of 28x28) ther is a single number.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/features2_5e8189cca733647f7c4ab1a5b6f4a3fa">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 60K numerical labels</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(mnist<span class="sc">$</span>train<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 60000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># integer values ranging from 0 to 9</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(mnist<span class="sc">$</span>train<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 9</code></pre>
</div>
</div>
<p>Check out the first digit</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/first-digit_d7abc621fc5053695f9be5561ba7d6a2">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>digit <span class="ot">&lt;-</span> mnist<span class="sc">$</span>train<span class="sc">$</span>x[<span class="dv">1</span>,,]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>digit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13]
 [1,]    0    0    0    0    0    0    0    0    0     0     0     0     0
 [2,]    0    0    0    0    0    0    0    0    0     0     0     0     0
 [3,]    0    0    0    0    0    0    0    0    0     0     0     0     0
 [4,]    0    0    0    0    0    0    0    0    0     0     0     0     0
 [5,]    0    0    0    0    0    0    0    0    0     0     0     0     0
 [6,]    0    0    0    0    0    0    0    0    0     0     0     0     3
 [7,]    0    0    0    0    0    0    0    0   30    36    94   154   170
 [8,]    0    0    0    0    0    0    0   49  238   253   253   253   253
 [9,]    0    0    0    0    0    0    0   18  219   253   253   253   253
[10,]    0    0    0    0    0    0    0    0   80   156   107   253   253
[11,]    0    0    0    0    0    0    0    0    0    14     1   154   253
[12,]    0    0    0    0    0    0    0    0    0     0     0   139   253
[13,]    0    0    0    0    0    0    0    0    0     0     0    11   190
[14,]    0    0    0    0    0    0    0    0    0     0     0     0    35
[15,]    0    0    0    0    0    0    0    0    0     0     0     0     0
[16,]    0    0    0    0    0    0    0    0    0     0     0     0     0
[17,]    0    0    0    0    0    0    0    0    0     0     0     0     0
[18,]    0    0    0    0    0    0    0    0    0     0     0     0     0
[19,]    0    0    0    0    0    0    0    0    0     0     0     0     0
[20,]    0    0    0    0    0    0    0    0    0     0     0     0    39
[21,]    0    0    0    0    0    0    0    0    0     0    24   114   221
[22,]    0    0    0    0    0    0    0    0   23    66   213   253   253
[23,]    0    0    0    0    0    0   18  171  219   253   253   253   253
[24,]    0    0    0    0   55  172  226  253  253   253   253   244   133
[25,]    0    0    0    0  136  253  253  253  212   135   132    16     0
[26,]    0    0    0    0    0    0    0    0    0     0     0     0     0
[27,]    0    0    0    0    0    0    0    0    0     0     0     0     0
[28,]    0    0    0    0    0    0    0    0    0     0     0     0     0
      [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24] [,25]
 [1,]     0     0     0     0     0     0     0     0     0     0     0     0
 [2,]     0     0     0     0     0     0     0     0     0     0     0     0
 [3,]     0     0     0     0     0     0     0     0     0     0     0     0
 [4,]     0     0     0     0     0     0     0     0     0     0     0     0
 [5,]     0     0     0     0     0     0     0     0     0     0     0     0
 [6,]    18    18    18   126   136   175    26   166   255   247   127     0
 [7,]   253   253   253   253   253   225   172   253   242   195    64     0
 [8,]   253   253   253   253   251    93    82    82    56    39     0     0
 [9,]   253   198   182   247   241     0     0     0     0     0     0     0
[10,]   205    11     0    43   154     0     0     0     0     0     0     0
[11,]    90     0     0     0     0     0     0     0     0     0     0     0
[12,]   190     2     0     0     0     0     0     0     0     0     0     0
[13,]   253    70     0     0     0     0     0     0     0     0     0     0
[14,]   241   225   160   108     1     0     0     0     0     0     0     0
[15,]    81   240   253   253   119    25     0     0     0     0     0     0
[16,]     0    45   186   253   253   150    27     0     0     0     0     0
[17,]     0     0    16    93   252   253   187     0     0     0     0     0
[18,]     0     0     0     0   249   253   249    64     0     0     0     0
[19,]     0    46   130   183   253   253   207     2     0     0     0     0
[20,]   148   229   253   253   253   250   182     0     0     0     0     0
[21,]   253   253   253   253   201    78     0     0     0     0     0     0
[22,]   253   253   198    81     2     0     0     0     0     0     0     0
[23,]   195    80     9     0     0     0     0     0     0     0     0     0
[24,]    11     0     0     0     0     0     0     0     0     0     0     0
[25,]     0     0     0     0     0     0     0     0     0     0     0     0
[26,]     0     0     0     0     0     0     0     0     0     0     0     0
[27,]     0     0     0     0     0     0     0     0     0     0     0     0
[28,]     0     0     0     0     0     0     0     0     0     0     0     0
      [,26] [,27] [,28]
 [1,]     0     0     0
 [2,]     0     0     0
 [3,]     0     0     0
 [4,]     0     0     0
 [5,]     0     0     0
 [6,]     0     0     0
 [7,]     0     0     0
 [8,]     0     0     0
 [9,]     0     0     0
[10,]     0     0     0
[11,]     0     0     0
[12,]     0     0     0
[13,]     0     0     0
[14,]     0     0     0
[15,]     0     0     0
[16,]     0     0     0
[17,]     0     0     0
[18,]     0     0     0
[19,]     0     0     0
[20,]     0     0     0
[21,]     0     0     0
[22,]     0     0     0
[23,]     0     0     0
[24,]     0     0     0
[25,]     0     0     0
[26,]     0     0     0
[27,]     0     0     0
[28,]     0     0     0</code></pre>
</div>
</div>
<p>Lets plot the first digit and compare to the above matrix.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/plot-first-digit_89f731deb1c297c9fbc629327922e119">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.raster</span>(digit, <span class="at">max =</span> <span class="dv">255</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/plot-first-digit-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>The associated label confirms it is number 5.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-3_7c4055d765aa71ae15e4915ccd2d0e94">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>mnist<span class="sc">$</span>train<span class="sc">$</span>y[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5</code></pre>
</div>
</div>
<p>Now lets check out the first 100 digits</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/plot-first-100-digits_9af3e8aade75177b0e1a1fbf59433aaf">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">10</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">as.raster</span>(mnist<span class="sc">$</span>train<span class="sc">$</span>x[i,,], <span class="at">max =</span> <span class="dv">255</span>))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/plot-first-100-digits-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="prepare-data" class="level1">
<h1>Prepare Data</h1>
<p>When we work with keras:</p>
<ul>
<li>training and test sets need to be independent</li>
<li>features and labels (aka target, response) need to be independent</li>
<li>use <code>%&lt;-%</code> for <strong><em>object unpacking</em></strong> (see <code>?zeallot::%&lt;-%</code>)</li>
</ul>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/extract-train-test_812f45455fb4b28971797f8d9edf9018">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">c</span>(train_images, train_labels), <span class="fu">c</span>(test_images, test_labels)) <span class="sc">%&lt;-%</span> mnist</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the above is the same as</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># train_images &lt;- mnist$train$x</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># train_labels &lt;- mnist$train$y</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># test_images &lt;- mnist$test$x</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># test_labels &lt;- mnist$test$y</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="shape-into-proper-tensor-form" class="level2">
<h2 class="anchored" data-anchor-id="shape-into-proper-tensor-form">Shape into proper tensor form</h2>
<p>The shape of our data is dependent on the type of DL model we are training. <em>Multi Layer Perceptrons (MLPs) require our data to be in a 2D tensor (aka matrix)</em>; however, our data are currently in a 3D tensor.</p>
<p><em>We can reshape our tensor from 3D to 2D. Much like a matrix can be flattened to a vector</em>:</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-4_8b5051508d9e460658fea3d202d804f4">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    1    4    7
[2,]    2    5    8
[3,]    3    6    9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># flattened matrix</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.vector</span>(m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3 4 5 6 7 8 9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Warning of how you invert the process !!!</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># matrix(as.vector(m), nrow=3)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can reshape a 3D array to a 2D array with <code>array_reshape()</code></p>
<div class="cell" data-layout-align="center" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-5_dd87368228f834214fbebb27e6af3bc2">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"images/reshape.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/reshape.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/reshape-to-2D-tensor_88b4e900c35b864dcdc2352d24549213">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reshape 3D tensor (aka array) to a 2D tensor (aka matrix)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>train_images <span class="ot">&lt;-</span> <span class="fu">array_reshape</span>(train_images, <span class="fu">c</span>(<span class="dv">60000</span>, <span class="dv">28</span> <span class="sc">*</span> <span class="dv">28</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>test_images <span class="ot">&lt;-</span> <span class="fu">array_reshape</span>(test_images, <span class="fu">c</span>(<span class="dv">10000</span>, <span class="dv">28</span> <span class="sc">*</span> <span class="dv">28</span>))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># our training data is now a matrix with 60K observations and</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 784 features (28 pixels x 28 pixels = 784)</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(train_images)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:60000, 1:784] 0 0 0 0 0 0 0 0 0 0 ...</code></pre>
</div>
</div>
<p>Since we are dealing with a multi-classification problem where the target ranges from 0-9, we’ll reformat the labels with <code>to_categorical()</code>.</p>
<p>This function takes a vector of <span class="math inline">\(N\)</span> integers of <span class="math inline">\(k\)</span> distinct classes and creates a matrix of <span class="math inline">\(N\)</span> rows and <span class="math inline">\(k\)</span> columns in such a way that if the nth value in the original vector, was a 7, now the nth row, column 8, in the transformed matrix, has a 1 and the remaining columns of this row contain a zero.</p>
<p><strong>Note</strong>: column 1 refers to the digit “0”, column 2 refers to the digit “1”, etc.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-6_0252ffcc9ddcae7046e66e16b48f06b2">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(train_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "array"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(train_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 60000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>train_labels <span class="ot">&lt;-</span> <span class="fu">to_categorical</span>(train_labels)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>test_labels <span class="ot">&lt;-</span> <span class="fu">to_categorical</span>(test_labels)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(train_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "matrix" "array" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(train_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 60000    10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(train_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
[1,]    0    0    0    0    0    1    0    0    0     0
[2,]    1    0    0    0    0    0    0    0    0     0
[3,]    0    0    0    0    1    0    0    0    0     0
[4,]    0    1    0    0    0    0    0    0    0     0
[5,]    0    0    0    0    0    0    0    0    0     1
[6,]    0    0    1    0    0    0    0    0    0     0</code></pre>
</div>
</div>
</section>
<section id="stabilize-learning-by-data-scaling" class="level2">
<h2 class="anchored" data-anchor-id="stabilize-learning-by-data-scaling">Stabilize learning by data scaling</h2>
<p>When applying DL models, our feature values should not be relatively large compared to the randomized initial weights <em>and</em> all our features should take values in roughly the same range.</p>
<blockquote class="blockquote">
<p><strong><em>When features have large or widely varying values, large gradient updates can be triggered that will prevent the network from converging</em></strong></p>
</blockquote>
<p><strong>Tips</strong>:</p>
<ol type="1">
<li><p>When all features have the same value range (i.e.&nbsp;images), we can standardize values between 0-1.</p></li>
<li><p>When features varying in range from one another (i.e.&nbsp;age, height, longitude) normalize each feature to have mean of 0 and standard deviation of 1 (?<code>scale()</code>)</p></li>
</ol>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-7_6f88b5bfa5c0e432e6ec0ba96ea5bf7d">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># all our features (pixels) range from 0-255</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(train_images)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   0 255</code></pre>
</div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-8_24d534926acc5e7edcdb88ba7079a83d">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># standardize train and test features</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>train_images <span class="ot">&lt;-</span> train_images <span class="sc">/</span> <span class="dv">255</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>test_images <span class="ot">&lt;-</span> test_images <span class="sc">/</span> <span class="dv">255</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="randomize-data" class="level2">
<h2 class="anchored" data-anchor-id="randomize-data">Randomize data</h2>
<p>Although this dataset is not ordered, it is a good practice to randomize data so that our train and validation datasets are properly represented.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-9_5354b51282fe9e86460689e0f6811a4e">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">nrow</span>(train_images)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>randomize <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq_len</span>(obs), <span class="at">size =</span> obs, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>train_images <span class="ot">&lt;-</span> train_images[randomize, ]</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>train_labels <span class="ot">&lt;-</span> train_labels[randomize, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once the data has been prepared we can proceed to train some DL models!!</p>
</section>
</section>
<section id="balance-batch-size-default-learning-rate" class="level1">
<h1>Balance Batch Size &amp; Default Learning Rate</h1>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Terms recall: Batch, Epoch, Learning rate.
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p><strong>Epoch</strong>: A complete pass through the entire training dataset.</p>
<ul>
<li>Example: Training a model on 1,000 images where each image is seen once.</li>
</ul></li>
<li><p><strong>Batch</strong>: A subset of the training dataset used to update the model’s parameters.</p>
<ul>
<li>Example: Processing 100 images at a time during training.</li>
</ul></li>
<li><p><strong>Mini-batch</strong>: A smaller subset of the training dataset used for parameter updates.</p>
<ul>
<li>Example: Processing 32 images at a time during training with limited memory.</li>
</ul></li>
</ul>
</div>
</div>
<p>The <em>learning rate</em> is the most important hyperparameter to get right but before I tuning it, I like to find a <em>batch size</em> that balances:</p>
<ul>
<li>smoothness of the learning curve</li>
<li>speed of training</li>
</ul>
<p><strong>Tips</strong>: start with…</p>
<ul>
<li>a default learning rate,</li>
<li>a single hidden layer with units set to around <code>mean(n_features + n_response_classes)</code>,</li>
<li>the default batch size of 32,</li>
<li>then test ranges of batch sizes [16, 32, 64, 128, 256, 512].</li>
</ul>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-10_e25150695a0ef93adf1ce93808f2626a">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get number of features</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>n_feat <span class="ot">&lt;-</span> <span class="fu">ncol</span>(train_images)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Define model architecture</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">'relu'</span>, </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">input_shape =</span> n_feat) <span class="sc">%&gt;%</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">'softmax'</span>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Define model architecture</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">'relu'</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(n_feat)) <span class="sc">%&gt;%</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">'softmax'</span>)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Define how our model is going to learn</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="st">"sgd"</span>,</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_1"
________________________________________________________________________________
 Layer (type)                       Output Shape                    Param #     
================================================================================
 dense_3 (Dense)                    (None, 512)                     401920      
 dense_2 (Dense)                    (None, 10)                      5130        
================================================================================
Total params: 407,050
Trainable params: 407,050
Non-trainable params: 0
________________________________________________________________________________</code></pre>
</div>
</div>
<p>Let’s train our model with the default batch size of 32.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-11_fc83bcaf5b6b6f9f902e6e98a57a5fb5">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Train our model</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  train_images, train_labels,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-12_8422239e9f0930977d204208272a5254">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Final epoch (plot to see history):
        loss: 0.1699
    accuracy: 0.953
    val_loss: 0.1778
val_accuracy: 0.9486 </code></pre>
</div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-13_8ca634405e61ae51602903bce003c222">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<section id="your-turn-3min" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-3min">Your turn! (3min)</h2>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Now retrain the same model but try with batch sizes of 16, 128, 512 while leaving everything else the same. How do the results (loss, accuracy, and compute time) compare?</p>
</div>
</div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-14_e1818c0baf20240d5a396a5d0ca0cd5f">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define model architecture</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">'relu'</span>, <span class="at">input_shape =</span> n_feat) <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">'softmax'</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co"># define how the model is gonig to learn</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="st">"sgd"</span>,</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  train_images, train_labels,</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span>,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">____ =</span> ____</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="pick-an-adaptive-learning-rate-optimizer" class="level1">
<h1>Pick an Adaptive Learning Rate Optimizer</h1>
<p>Once we’ve picked an adequate batch size, next we want to start tuning the learning rate. There are two main considerations:</p>
<ol type="1">
<li>We usually always assess different learning rates ranging from [1e-1, 1e-7].</li>
<li>Adaptive learning rate optimizers nearly always outperform regular SGD</li>
</ol>
<blockquote class="blockquote">
<p><strong><em>Adaptive learning rates help to escape “saddle points”.</em></strong></p>
</blockquote>
<p><img src="images/contours_evaluation_optimizers.gif" class="img-fluid"> <img src="images/saddle_point_evaluation_optimizers.gif" class="img-fluid"></p>
<div class="{callout-tips}">
<p>The primary adaptive learning rates include:</p>
<ol type="1">
<li><p><strong>SGD (Stochastic Gradient Descent)</strong>: Basic optimization algorithm that updates model parameters based on the negative gradient of the loss function.</p></li>
<li><p><strong>SGD with momentum</strong>: Extends SGD by incorporating a momentum term, which helps accelerate learning and maintain direction in the presence of noisy or sparse gradients.</p></li>
<li><p><strong>nAG (Nesterov Accelerated Gradient)</strong>: Variant of SGD that improves convergence speed by calculating the gradient at a lookahead position, providing more accurate gradient information.</p></li>
<li><p><strong>Adagrad (Adaptive Gradient)</strong>: Adapts the learning rate for each parameter based on the historical gradients, giving more weight to parameters with smaller gradients.</p></li>
<li><p><strong>Adadelta</strong>: Extension of Adagrad that dynamically adjusts the learning rate using the ratio of accumulated gradients to accumulated parameter updates.</p></li>
<li><p><strong>RMSprop</strong> (Root Mean Square Propagation): Adaptive learning rate algorithm that normalizes learning rates by dividing them by an exponentially weighted moving average of squared gradients.</p></li>
</ol>
<p>These optimization techniques offer different strategies for updating model parameters, improving convergence and adapting the learning rate to optimize model performance.</p>
<p>See <code>?optimizer_sgd()</code> or <code>?optimizer_rmsprop()</code></p>
<p>See https://ruder.io/optimizing-gradient-descent/ for more details</p>
</div>
<section id="your-turn-5min" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-5min">Your turn! (5min)</h2>
<p>Retrain our DL model using:</p>
<ul>
<li>SGD with momentum (<code>optimizer_sgd()</code>)
<ul>
<li>Try default learning rate (0.01) with momentum (0.5, 0.9, 0.99)</li>
<li>Try larger learning rates (0.1, 1) with momentum</li>
</ul></li>
<li>RMSprop (<code>optimizer_rmsprop()</code>)
<ul>
<li>What is the default learning rate? Train with default.</li>
<li>Try a larger learning rate. What happens?</li>
</ul></li>
<li>Adam (<code>optimizer_adam()</code>)
<ul>
<li>What is the default learning rate? Train with default.</li>
<li>Try a larger learning rate. What happens?</li>
</ul></li>
</ul>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-15_43f779167926484080378d15de2c0f5d">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">'relu'</span>, <span class="at">input_shape =</span> n_feat) <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">'softmax'</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> ____,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  train_images, train_labels,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span>,</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">128</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="add-callbacks" class="level1">
<h1>Add Callbacks</h1>
<p>When training a model, sometimes we want to:</p>
<ul>
<li>automatically stop a model once performance has stopped improving</li>
<li>dynamically adjust values of certain parameters (i.e.&nbsp;learning rate)</li>
<li>log model information to use or visualize later on</li>
<li>continually save the model during training and save the model with the best performance</li>
</ul>
<p>Keras provides a suite of tools called _<strong>callbacks</strong> that help us to monitor, control, and customize the training procedure.</p>
<section id="stop-training-at-the-right-time" class="level2">
<h2 class="anchored" data-anchor-id="stop-training-at-the-right-time">Stop training at the right time</h2>
<p>We often don’t know how many epochs we’ll need to reach a minimum loss. The early stopping callback allows us to automatically stop training after we experience no improvement in our loss after <code>patience</code> number of epochs.</p>
<div class="{caution-tip}">
<ul>
<li><p>If you are going to use the model after training you always want to retain the “best” model, which is the model with the lowest loss. <code>restore_best_weights</code> will restore the weights for this “best” model even after you’ve passed it by n epochs.</p></li>
<li><p>Sometimes your model will stall on a low validation loss resulting in a tie. Even with early stopping the model will continue to train for all the epochs. <code>min_delta</code> allows you to state some small value that the loss must improve by otherwise it will stop.</p></li>
</ul>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-16_27a3129486aef2472faac3f595534e01">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">'relu'</span>, <span class="at">input_shape =</span> n_feat) <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">'softmax'</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_sgd</span>(<span class="at">learning_rate =</span> <span class="fl">0.1</span>, </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">momentum =</span> <span class="fl">0.9</span>),</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  train_images, train_labels,</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span>,</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">callback =</span> <span class="fu">callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">3</span>,</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">restore_best_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">min_delta =</span> <span class="fl">0.0001</span>)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-17_02883fd92b12301264b039ba1277f893">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Final epoch (plot to see history):
        loss: 0.003236
    accuracy: 0.9998
    val_loss: 0.06499
val_accuracy: 0.9832 </code></pre>
</div>
</div>
<p>Note how we did not train for all the epochs…only until our loss didn’t improve by 0.0001 for 3 consistent epochs.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-18_897546742aedf16f5d6a051ef3e44ef9">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="add-a-learning-rate-scheduler" class="level2">
<h2 class="anchored" data-anchor-id="add-a-learning-rate-scheduler">Add a learning rate scheduler</h2>
<p>Although adaptive learning rate optimizers adjust the velocity of weight updates depending on the loss surface, we can also incorporate additional ways to modify the learning rate “on the fly”.</p>
<div class="{callback-note}">
<ul>
<li><p>Learning rate decay reduces the learning rate at each epoch. Note the <code>decay</code> argument in <code>?optimizer_xxx()</code>.</p></li>
<li><p>There has been some great research on cyclical learning rates (see https://arxiv.org/abs/1506.01186). You can incorporate custom learning rates such as this with <code>callback_learning_rate_scheduler()</code>. This is more advanced but definitely worth reading.</p></li>
<li><p>A simpler, and very practical approach, is to reduce the learning rate after the model has stopped improving with <code>callback_reduce_lr_on_plateau()</code>. This approach allows the model to tell us when to reduce the learning rate.</p></li>
</ul>
</div>
<div class="{callback-tip}">
<p>When using <code>decay</code> or <code>callback_reduce_lr_on_plateau()</code>, you can usually increase the base learning rate so that you learn quickly early on and then the learning rate will reduce so you can take smaller steps as you approach the minimum loss.</p>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-19_97723c6210242da5e15ca7a202d1dccd">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">'relu'</span>, <span class="at">input_shape =</span> n_feat) <span class="sc">%&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">'softmax'</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_sgd</span>(<span class="at">learning_rate =</span> <span class="fl">0.1</span>, <span class="at">momentum =</span> <span class="fl">0.9</span>),</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  train_images, train_labels,</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span>,</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">callback =</span> <span class="fu">list</span>(</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">3</span>, <span class="at">restore_best_weights =</span> <span class="cn">TRUE</span>, <span class="at">min_delta =</span> <span class="fl">0.0001</span>),</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">callback_reduce_lr_on_plateau</span>(<span class="at">patience =</span> <span class="dv">1</span>, <span class="at">factor =</span> <span class="fl">0.1</span>)</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-20_1830d6ba0806f8fec56da9f11aca05f9">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Final epoch (plot to see history):
        loss: 0.007838
    accuracy: 0.9994
    val_loss: 0.06073
val_accuracy: 0.9835
          lr: 0.0001 </code></pre>
</div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-21_93ac68dfd7b0ca670749d2b2daaed226">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-22_119c6c9d778567989c72c19469eae6ed">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history<span class="sc">$</span>metrics<span class="sc">$</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
</section>
<section id="explore-model-capacity" class="level1">
<h1>Explore Model Capacity</h1>
<p>Now that we have found a pretty good learning rate and we have good control over our training procedure with callbacks, we can start to assess how the <em>capacity</em> of our model effects performance.</p>
<div class="{callback-note}">
<p>The <strong>capacity</strong> of a deep learning model refers to its ability to learn complex patterns in the data.</p>
<p>It is determined by the architecture, including the number of layers and neurons.</p>
<p>Higher capacity allows the model to capture more intricate details, but it also increases the risk of overfitting.</p>
<p>Finding the right balance is important for optimal performance.</p>
<p>Capacity is usually controlled in two ways:</p>
<ul>
<li><strong>width</strong>: the number of units in a hidden layer</li>
<li><strong>depth</strong>: the number of hidden layers</li>
</ul>
</div>
<section id="your-turn-5min-1" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-5min-1">Your turn! (5min)</h2>
<p>Explore different model capacities while all other parameters constant. Try increasing</p>
<ul>
<li>Width: remember that the number of units is usually a power of 2 (i.e.&nbsp;32, 64, 128, 256, 512, 1024).</li>
<li>Depth: try using 2 or 3 hidden layers</li>
</ul>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-23_a5e902d848462226c4115510659373bb">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  ___________ <span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">'softmax'</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_sgd</span>(<span class="at">lr =</span> <span class="fl">0.1</span>, <span class="at">momentum =</span> <span class="fl">0.9</span>),</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  train_images, train_labels,</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span>,</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">callback =</span> <span class="fu">list</span>(</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">3</span>, <span class="at">restore_best_weights =</span> <span class="cn">TRUE</span>, <span class="at">min_delta =</span> <span class="fl">0.0001</span>),</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">callback_reduce_lr_on_plateau</span>(<span class="at">patience =</span> <span class="dv">1</span>, <span class="at">factor =</span> <span class="fl">0.1</span>)</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="smart-experimenting" class="level2">
<h2 class="anchored" data-anchor-id="smart-experimenting">Smart experimenting</h2>
<p>As we start to experiment more, it becomes harder to organize and compare our results. Let’s make it more efficient by:</p>
<ul>
<li>Creating a function that allows us to dynamically change the number of layers and units.</li>
<li>Using <code>callback_tensorboard()</code> which allows us to save and visually compare results.</li>
</ul>
<div class="{callblock-tip}">
<p>There is another approach to performing grid searches. See the extras notebook https://rstudio-conf-2020.github.io/dl-keras-tf/notebooks/imdb-grid-search.nb.html for details.</p>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-24_f7ee177acb4e31f0e15569464bb325d3">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>train_model <span class="ot">&lt;-</span> <span class="cf">function</span>(n_units, n_layers, log_to) {</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a model with a single hidden input layer</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> n_units, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">input_shape =</span> n_feat)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add additional hidden layers based on input</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n_layers <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(n_layers <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">%&gt;%</span> <span class="fu">layer_dense</span>(<span class="at">units =</span> n_units, <span class="at">activation =</span> <span class="st">"relu"</span>)</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add final output layer</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>  model <span class="sc">%&gt;%</span> <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">"softmax"</span>)</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compile model</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>  model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimizer =</span> <span class="fu">optimizer_sgd</span>(<span class="at">learning_rate =</span> <span class="fl">0.1</span>, <span class="at">momentum =</span> <span class="fl">0.9</span>),</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># train model and store results with callback_tensorboard()</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>  history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>    train_images, train_labels,</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">validation_split =</span> <span class="fl">0.2</span>,</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">callback =</span> <span class="fu">list</span>(</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">3</span>, <span class="at">restore_best_weights =</span> <span class="cn">TRUE</span>, <span class="at">min_delta =</span> <span class="fl">0.0001</span>),</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">callback_reduce_lr_on_plateau</span>(<span class="at">patience =</span> <span class="dv">1</span>, <span class="at">factor =</span> <span class="fl">0.1</span>),</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">callback_tensorboard</span>(<span class="at">log_dir =</span> log_to)</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(history)</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can create a grid for various model capacities. We include an ID for each model, which we will use to save our results within <code>callback_tensorboard()</code>.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-25_cc9377566ecf871bf55aab28c8f6fbf2">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">units =</span> <span class="fu">c</span>(<span class="dv">128</span>, <span class="dv">256</span>, <span class="dv">512</span>, <span class="dv">1024</span>),</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">layers =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">paste0</span>(<span class="st">"mlp_"</span>, layers, <span class="st">"_layers_"</span>, units, <span class="st">"_units"</span>))</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 3
   units layers id                     
   &lt;dbl&gt;  &lt;int&gt; &lt;chr&gt;                  
 1   128      1 mlp_1_layers_128_units 
 2   128      2 mlp_2_layers_128_units 
 3   128      3 mlp_3_layers_128_units 
 4   256      1 mlp_1_layers_256_units 
 5   256      2 mlp_2_layers_256_units 
 6   256      3 mlp_3_layers_256_units 
 7   512      1 mlp_1_layers_512_units 
 8   512      2 mlp_2_layers_512_units 
 9   512      3 mlp_3_layers_512_units 
10  1024      1 mlp_1_layers_1024_units
11  1024      2 mlp_2_layers_1024_units
12  1024      3 mlp_3_layers_1024_units</code></pre>
</div>
</div>
<p>Now we can loop through each model capacity combination and train our models.</p>
<p>This will take a few minutes so this is a good time to save your work and take a break.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-26_307416d47bd2d3023161329e45a475c0">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (row <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(grid))) {</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get parameters</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  units <span class="ot">&lt;-</span> grid[[row, <span class="st">"units"</span>]]</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  layers <span class="ot">&lt;-</span> grid[[row, <span class="st">"layers"</span>]]</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"mnist/"</span>, grid[[row, <span class="st">"id"</span>]])</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># provide status update</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(layers, <span class="st">"hidden layer(s) with"</span>, units, <span class="st">"neurons: "</span>)</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># train model</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">train_model</span>(<span class="at">n_units =</span> units, <span class="at">n_layers =</span> layers, <span class="at">log_to =</span> file_path)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>  min_loss <span class="ot">&lt;-</span> <span class="fu">min</span>(m<span class="sc">$</span>metrics<span class="sc">$</span>val_loss, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># update status with loss</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(min_loss, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 hidden layer(s) with 128 neurons: 0.07069184 
2 hidden layer(s) with 128 neurons: 0.06938207 
3 hidden layer(s) with 128 neurons: 0.06946184 
1 hidden layer(s) with 256 neurons: 0.06554866 
2 hidden layer(s) with 256 neurons: 0.06640807 
3 hidden layer(s) with 256 neurons: 0.07036863 
1 hidden layer(s) with 512 neurons: 0.06244506 
2 hidden layer(s) with 512 neurons: 0.06106765 
3 hidden layer(s) with 512 neurons: 0.06557445 
1 hidden layer(s) with 1024 neurons: 0.06027493 
2 hidden layer(s) with 1024 neurons: 0.05934745 
3 hidden layer(s) with 1024 neurons: 0.05973132 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
 128.89   75.78  287.67 </code></pre>
</div>
</div>
<p>Our results suggest that larger width models tend to perform better but it is unclear if deeper models add much benefit. However, to get more clarity we can analyze the learning rates with <code>tensorboard()</code>.</p>
<p>Note that <code>callback_tensorboard()</code> saved all the model runs in <code>/mnist</code> subdirectory.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-27_a712df218b866afc526353fdaca1d4ca">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tensorboard</span>(<span class="st">"mnist"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Started TensorBoard at http://127.0.0.1:3383 </code></pre>
</div>
</div>
</section>
<section id="your-turn-3-min" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-3-min">Your turn! (3 min)</h2>
<p>Retrain the model with:</p>
<ul>
<li>2 hidden layers</li>
<li>1024 units in each hidden layer</li>
<li>early stopping after 3 epochs of no improvement</li>
<li>reduce learning rate after 1 epoch of no improvement</li>
</ul>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-28_131fe076aa88825828ae52227b050a9a">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  ___________ <span class="sc">%&gt;%</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  ___________</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_sgd</span>(<span class="at">lr =</span> <span class="fl">0.1</span>, <span class="at">momentum =</span> <span class="fl">0.9</span>),</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>  train_images, train_labels,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span>,</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">callback =</span> <span class="fu">list</span>(</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">callback______</span>(<span class="at">patience =</span> _____, <span class="at">restore_best_weights =</span> <span class="cn">TRUE</span>, <span class="at">min_delta =</span> <span class="fl">0.0001</span>),</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">callback______</span>(<span class="at">patience =</span> _____, <span class="at">factor =</span> <span class="fl">0.1</span>)</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="regularize-overfitting" class="level1">
<h1>Regularize Overfitting</h1>
<p>Often, once we’ve found a model that minimizes the loss, there is still some overfitting that is occuring…sometimes a lot.</p>
<p>So our next objective is to try flatten the validation loss learning curve and bring it as close to the training loss curve as possible.</p>
<section id="weight-decay" class="level2">
<h2 class="anchored" data-anchor-id="weight-decay">Weight decay</h2>
<p>A common way to mitigate overfitting is to put constraints on the complexity of a network by forcing its weights to take on small values, which makes the distribution of weight values more regular.</p>
<p>This is called <em>weight regularization</em> and its done by adding to the loss function of the network a cost associated with having large weights.</p>
<div class="{callblock-note}">
<p>If you a familiar with regularized regression <a href="http://bit.ly/homlr-regularize">ℹ️</a> (lasso, ridge, elastic nets) then weight regularization is essentially the same thing. <a href="http://bit.ly/dl-02#23">ℹ️</a></p>
<p><span class="math display">\[Loss = MSE + \lambda \sum^p_{j=1} w^2_j\]</span></p>
<p><img src="images/weight-decay.png" class="img-fluid"></p>
</div>
<div class="{callblock-tip}">
<ul>
<li>Although you can use L1, L2 or a combination, L2 is by far the most common and is known as <strong><em>weight decay</em></strong> in the context of neural nets.</li>
<li>Optimal values vary but when tuning we typically start with factors of <span class="math inline">\(10^{-s}\)</span> where s ranges between 1-4 (0.1, 0.01, …, 0.0001).</li>
<li>The larger the weight regularizer, the more epochs generally required to reach a minimum loss.</li>
<li>Weight decay can cause a noisier learning curve so its often beneficial to increase the <code>patience</code> parameter for early stopping if this is noticable.</li>
</ul>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-29_e463e7609c70f37919c0f752dbafd00d">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">input_shape =</span> n_feat,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel_regularizer =</span> <span class="fu">regularizer_l2</span>(<span class="at">l =</span> <span class="fl">0.001</span>)    <span class="co"># regularization parameter</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">"relu"</span>,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel_regularizer =</span> <span class="fu">regularizer_l2</span>(<span class="at">l =</span> <span class="fl">0.001</span>)    <span class="co"># regularization parameter</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">"softmax"</span>)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_sgd</span>(<span class="at">learning_rate =</span> <span class="fl">0.1</span>, </span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>                            <span class="at">momentum =</span> <span class="fl">0.9</span>),</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>  train_images, train_labels,</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span>,</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">callback =</span> <span class="fu">list</span>(</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">3</span>, <span class="at">restore_best_weights =</span> <span class="cn">TRUE</span>, <span class="at">min_delta =</span> <span class="fl">0.0001</span>),</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">callback_reduce_lr_on_plateau</span>(<span class="at">patience =</span> <span class="dv">1</span>, <span class="at">factor =</span> <span class="fl">0.1</span>)</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-30_913cc84e94b4a7c28b6277a7c749db80">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Final epoch (plot to see history):
        loss: 0.09333
    accuracy: 0.996
    val_loss: 0.1284
val_accuracy: 0.9823
          lr: 0.001 </code></pre>
</div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-31_b16ca5ec04982b03c8392c0ba4f14f86">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="dropout" class="level2">
<h2 class="anchored" data-anchor-id="dropout">Dropout</h2>
<div class="{callblock-note}">
<p><strong><em>Dropout</em></strong> is one of the most effective and commonly used regularization techniques for neural networks.</p>
<p>Dropout applied to a layer randomly drops out (sets to zero) a certain percentage of the output features of that layer.</p>
<p>By randomly dropping some of a layer’s outputs we minimize the chance of fitting patterns to noise in the data, a common cause of overfitting.</p>
<p><img src="images/dropout.png" class="img-fluid"></p>
</div>
<div class="{call-block-tip}">
<ul>
<li><p>Dropout rates typically ranges between 0.2-0.5. Sometimes higher rates are necessary but note that you will get a warning when supplying rate &gt; 0.5.</p></li>
<li><p>The higher the dropout rate, the slower the convergence so you may need to increase the number of epochs.</p></li>
<li><p>Its common to apply dropout after each hidden layer and with the same rate;</p></li>
<li><p>however, this is not necessary.</p></li>
</ul>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-32_44dd7e3467292b054f04deea64b5401c">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">input_shape =</span> n_feat) <span class="sc">%&gt;%</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span>                            <span class="co"># regularization parameter</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span>                           <span class="co"># regularization parameter</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">"softmax"</span>)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_sgd</span>(<span class="at">learning_rate =</span> <span class="fl">0.1</span>, </span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">momentum =</span> <span class="fl">0.9</span>),</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>  train_images, train_labels,</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span>,</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">callback =</span> <span class="fu">list</span>(</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">3</span>, <span class="at">restore_best_weights =</span> <span class="cn">TRUE</span>, <span class="at">min_delta =</span> <span class="fl">0.0001</span>),</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">callback_reduce_lr_on_plateau</span>(<span class="at">patience =</span> <span class="dv">1</span>, <span class="at">factor =</span> <span class="fl">0.1</span>)</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-33_c046da8f185a73dff9146e3270f64a3f">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    epoch        value   metric       data
1       1 3.242483e-01     loss   training
2       2 1.482577e-01     loss   training
3       3 1.137299e-01     loss   training
4       4 9.758937e-02     loss   training
5       5 7.881726e-02     loss   training
6       6 6.788949e-02     loss   training
7       7 6.261241e-02     loss   training
8       8 4.050179e-02     loss   training
9       9 3.128683e-02     loss   training
10     10 2.672179e-02     loss   training
11     11 2.508097e-02     loss   training
12     12 2.197508e-02     loss   training
13     13 2.042278e-02     loss   training
14     14 2.059718e-02     loss   training
15     15           NA     loss   training
16     16           NA     loss   training
17     17           NA     loss   training
18     18           NA     loss   training
19     19           NA     loss   training
20     20           NA     loss   training
21      1 8.989375e-01 accuracy   training
22      2 9.537917e-01 accuracy   training
23      3 9.648333e-01 accuracy   training
24      4 9.694791e-01 accuracy   training
25      5 9.750834e-01 accuracy   training
26      6 9.785417e-01 accuracy   training
27      7 9.797083e-01 accuracy   training
28      8 9.865834e-01 accuracy   training
29      9 9.901250e-01 accuracy   training
30     10 9.915208e-01 accuracy   training
31     11 9.917708e-01 accuracy   training
32     12 9.930000e-01 accuracy   training
33     13 9.931250e-01 accuracy   training
34     14 9.934375e-01 accuracy   training
35     15           NA accuracy   training
36     16           NA accuracy   training
37     17           NA accuracy   training
38     18           NA accuracy   training
39     19           NA accuracy   training
40     20           NA accuracy   training
41      1 1.419821e-01     loss validation
42      2 1.198308e-01     loss validation
43      3 9.774947e-02     loss validation
44      4 8.783271e-02     loss validation
45      5 8.001570e-02     loss validation
46      6 7.208887e-02     loss validation
47      7 7.537550e-02     loss validation
48      8 6.350064e-02     loss validation
49      9 6.203371e-02     loss validation
50     10 6.138184e-02     loss validation
51     11 6.125287e-02     loss validation
52     12 6.218536e-02     loss validation
53     13 6.142388e-02     loss validation
54     14 6.137693e-02     loss validation
55     15           NA     loss validation
56     16           NA     loss validation
57     17           NA     loss validation
58     18           NA     loss validation
59     19           NA     loss validation
60     20           NA     loss validation
61      1 9.568334e-01 accuracy validation
62      2 9.630000e-01 accuracy validation
63      3 9.705000e-01 accuracy validation
64      4 9.735833e-01 accuracy validation
65      5 9.779167e-01 accuracy validation
66      6 9.800833e-01 accuracy validation
67      7 9.792500e-01 accuracy validation
68      8 9.827500e-01 accuracy validation
69      9 9.837500e-01 accuracy validation
70     10 9.838333e-01 accuracy validation
71     11 9.838333e-01 accuracy validation
72     12 9.841667e-01 accuracy validation
73     13 9.843333e-01 accuracy validation
74     14 9.843333e-01 accuracy validation
75     15           NA accuracy validation
76     16           NA accuracy validation
77     17           NA accuracy validation
78     18           NA accuracy validation
79     19           NA accuracy validation
80     20           NA accuracy validation
81      1 1.000000e-01       lr   training
82      2 1.000000e-01       lr   training
83      3 1.000000e-01       lr   training
84      4 1.000000e-01       lr   training
85      5 1.000000e-01       lr   training
86      6 1.000000e-01       lr   training
87      7 1.000000e-01       lr   training
88      8 1.000000e-02       lr   training
89      9 1.000000e-02       lr   training
90     10 1.000000e-02       lr   training
91     11 1.000000e-02       lr   training
92     12 1.000000e-02       lr   training
93     13 9.999999e-04       lr   training
94     14 9.999999e-05       lr   training
95     15           NA       lr   training
96     16           NA       lr   training
97     17           NA       lr   training
98     18           NA       lr   training
99     19           NA       lr   training
100    20           NA       lr   training</code></pre>
</div>
</div>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-34_2164618302c3bffc43e1e19045b371aa">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
</section>
<section id="repeat" class="level1">
<h1>Repeat</h1>
<p>At this point, we have a pretty good model. However, often, iterating over these steps can improve model performance even further. For brevity, we’ll act as if we have found a sufficient solution.</p>
</section>
<section id="evaluate-results" class="level1">
<h1>Evaluate results</h1>
<p>Once a final model is chosen, we can evaluate the model on our test set to provide us with a accurate expectation of our generalization error. Our goal is that our test error is very close to our validation error.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-35_4f8c1612d3f8fdebc95cb090f3a75d60">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(test_images, test_labels, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      loss   accuracy 
0.05530928 0.98350000 </code></pre>
</div>
</div>
<section id="confusion-matrix" class="level2">
<h2 class="anchored" data-anchor-id="confusion-matrix">Confusion matrix</h2>
<p>To understand our model’s performance across the different response classes, we can assess a confusion matrix <a href="https://bradleyboehmke.github.io/HOML/process.html#classification-models">ℹ️</a>.</p>
<p>First, we need to predict our classes and also get the actual response values.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-36_afbeca6259dd14c3fdd0cae76ee14ee8">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">predict</span>(test_images) <span class="sc">%&gt;%</span> <span class="fu">k_argmax</span>()</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>actual <span class="ot">&lt;-</span> mnist<span class="sc">$</span>test<span class="sc">$</span>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see the number of missed predictions in our test set</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-37_0a8223612181fc58fd27863659df5596">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">as.array</span>(predictions)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>missed_predictions <span class="ot">&lt;-</span> <span class="fu">sum</span>(predictions <span class="sc">!=</span> actual)</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>missed_predictions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 165</code></pre>
</div>
</div>
<p>We can use <code>caret::confusionMatrix()</code> to get our confusion matrix. We can see which digits our model confuses the most by analyzing the confusion matrix.</p>
<ul>
<li>9s are often confused with 4s</li>
<li>6s are often confused with 0s &amp; 5s</li>
<li>etc.</li>
</ul>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/confusion-matrix_5bb3db31cce0c3e73bf3dc24e3e470fb">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">confusionMatrix</span>(<span class="fu">factor</span>(predictions), <span class="fu">factor</span>(actual))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction    0    1    2    3    4    5    6    7    8    9
         0  971    0    4    0    1    2    3    1    4    1
         1    1 1128    0    0    1    0    3    5    0    2
         2    0    1 1017    4    2    0    0    7    3    0
         3    0    2    2  993    1    7    0    1    3    3
         4    1    0    1    0  965    0    3    0    1    9
         5    0    1    1    4    0  874    7    0    3    2
         6    3    2    2    0    3    2  940    0    2    1
         7    1    0    3    3    1    1    1 1009    3    4
         8    2    1    2    5    2    2    1    2  952    1
         9    1    0    0    1    6    4    0    3    3  986

Overall Statistics
                                          
               Accuracy : 0.9835          
                 95% CI : (0.9808, 0.9859)
    No Information Rate : 0.1135          
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.9817          
                                          
 Mcnemar's Test P-Value : NA              

Statistics by Class:

                     Class: 0 Class: 1 Class: 2 Class: 3 Class: 4 Class: 5
Sensitivity            0.9908   0.9938   0.9855   0.9832   0.9827   0.9798
Specificity            0.9982   0.9986   0.9981   0.9979   0.9983   0.9980
Pos Pred Value         0.9838   0.9895   0.9836   0.9812   0.9847   0.9798
Neg Pred Value         0.9990   0.9992   0.9983   0.9981   0.9981   0.9980
Prevalence             0.0980   0.1135   0.1032   0.1010   0.0982   0.0892
Detection Rate         0.0971   0.1128   0.1017   0.0993   0.0965   0.0874
Detection Prevalence   0.0987   0.1140   0.1034   0.1012   0.0980   0.0892
Balanced Accuracy      0.9945   0.9962   0.9918   0.9905   0.9905   0.9889
                     Class: 6 Class: 7 Class: 8 Class: 9
Sensitivity            0.9812   0.9815   0.9774   0.9772
Specificity            0.9983   0.9981   0.9980   0.9980
Pos Pred Value         0.9843   0.9834   0.9814   0.9821
Neg Pred Value         0.9980   0.9979   0.9976   0.9974
Prevalence             0.0958   0.1028   0.0974   0.1009
Detection Rate         0.0940   0.1009   0.0952   0.0986
Detection Prevalence   0.0955   0.1026   0.0970   0.1004
Balanced Accuracy      0.9898   0.9898   0.9877   0.9876</code></pre>
</div>
</div>
</section>
<section id="visualize-missed-predictions" class="level2">
<h2 class="anchored" data-anchor-id="visualize-missed-predictions">Visualize missed predictions</h2>
<p>We can also visualize this with the following:</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/visual-confusion-matrix_fbd3ee7ed4f517d3f1da505ed138b781">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  actual,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  predictions</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(actual <span class="sc">!=</span> predictions) <span class="sc">%&gt;%</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(actual, predictions) <span class="sc">%&gt;%</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">perc =</span> n <span class="sc">/</span> <span class="fu">n</span>() <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(actual, predictions, <span class="at">size =</span> n)) <span class="sc">+</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">col =</span> <span class="st">"#9F92C6"</span>) <span class="sc">+</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"Actual Target"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>) <span class="sc">+</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"Prediction"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>) <span class="sc">+</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_area</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>), <span class="at">max_size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste</span>(missed_predictions, <span class="st">"mismatches"</span>)) <span class="sc">+</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">'Adapted from Rick Scavetta'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/visual-confusion-matrix-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
</section>
<section id="visualize-missed-predictions-1" class="level1">
<h1>Visualize missed predictions</h1>
<p>Lastly, lets check out those mispredicted digits.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/mis-predicted-digits_bf3cc3e0a3162482e8946d3abbde80b8">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>missed <span class="ot">&lt;-</span> <span class="fu">which</span>(predictions <span class="sc">!=</span> actual)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>plot_dim <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fu">sqrt</span>(<span class="fu">length</span>(missed)))</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(plot_dim, plot_dim), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> missed) {</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">as.raster</span>(mnist<span class="sc">$</span>test<span class="sc">$</span>x[i,,], <span class="at">max =</span> <span class="dv">255</span>))</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/mis-predicted-digits-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>If we look at the predicted vs actual we can reason about why our model mispredicted some of the digits.</p>
<div class="cell" data-hash="Introduction_to_Keras-Lab_cache/html/unnamed-chunk-38_d6e229df051d7f0044b31839b5df712c">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>))</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> missed[<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>]) {</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">as.raster</span>(mnist<span class="sc">$</span>test<span class="sc">$</span>x[i,,], <span class="at">max =</span> <span class="dv">255</span>)) </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">title</span>(<span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Predicted:"</span>, predictions[i]))</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Introduction_to_Keras-Lab_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="key-takeaways" class="level1">
<h1>Key takeaways</h1>
<p>Follow these steps and guidelines when tuning your DL model:</p>
<ol type="1">
<li>Prepare data
<ul>
<li>data needs to be shaped into the right tensor dimensions</li>
<li>data should be scaled so they don’t trigger exploding gradients</li>
</ul></li>
<li>Balance batch size with a default learning rate so that…
<ul>
<li>your learning curve is not too noisy</li>
<li>the training compute time is sufficient</li>
</ul></li>
<li>Tune the adaptive learning rate optimizer
<ul>
<li>compare SGD+momentum with RMSprop &amp; Adam</li>
<li>assess learning rates on log scale between [1e-1, 1e-7]</li>
</ul></li>
<li>Add callbacks to control training
<ul>
<li>use early stopping for more efficient training</li>
<li>use an adaptive learning rate callback to have more control of the learning rate</li>
</ul></li>
<li>Explore model capacity
<ul>
<li>compare adding width vs depth (consider loss vs.&nbsp;training time)</li>
<li>be smart with your experiments (use tensorboard callback!)</li>
</ul></li>
<li>Regularize overfitting
<ul>
<li>weight decay controls magnitude of weights; start by assessing values btwn 0.1, 0.01, …, 0.0001</li>
<li>dropout minimizes happenstance patterns from noise; typical values range from 0.2-0.5.</li>
</ul></li>
<li>Iterate, iterate, iterate!</li>
</ol>
</section>
<section id="references" class="level1">
<h1>References</h1>
<section id="workshops" class="level3">
<h3 class="anchored" data-anchor-id="workshops">Workshops</h3>
<ul>
<li><a href="https://bios691-deep-learning-r.netlify.app/">Deep learning with R <em>Summer course</em></a></li>
<li><a href="https://github.com/rstudio-conf-2020/dl-keras-tf">Deep learning with keras and Tensorflow in R (Rstudio conf. 2020)</a></li>
</ul>
</section>
<section id="books" class="level3">
<h3 class="anchored" data-anchor-id="books">Books</h3>
<ul>
<li><a href="https://livebook.manning.com/book/deep-learning-with-r-second-edition">Deep learning with R, 2nd edition. F. Chollet</a></li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>